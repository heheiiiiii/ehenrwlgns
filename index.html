<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>임도둑을 잡아라</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(to bottom, #e5e7eb 0%, #f9fafb 35%, #e5e7eb 100%);
      color: #111827;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    /* 건물 전체 느낌 */
    .building-wrapper {
      padding: 10px 10px 16px;
      background: linear-gradient(to bottom, #1f2937 0%, #111827 35%, #030712 100%);
      border-radius: 24px;
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(15, 23, 42, 0.9);
    }
    .building-roof {
      height: 14px;
      border-radius: 16px 16px 4px 4px;
      background: linear-gradient(to right, #0f172a, #111827, #020617);
      margin-bottom: 6px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
    }
    .building-roof::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(148, 163, 184, 0.35), transparent 60%);
      opacity: 0.8;
    }
    .building-body {
      background: linear-gradient(145deg, #111827, #020617);
      border-radius: 18px;
      padding: 1px;
    }

    .game-container {
      width: 100%;
      max-width: 420px;
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #1f2937;
      padding: 16px 18px 18px;
      position: relative;
      overflow: hidden;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 8px;
    }
    .title-box {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .title {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
    }
    .subtitle {
      font-size: 11px;
      color: #6b7280;
    }
    .status-box {
      text-align: right;
      font-size: 11px;
      line-height: 1.4;
    }
    .status-box span.label {
      color: #9ca3af;
    }
    .status-box span.value {
      font-weight: 600;
      color: #111827;
    }
    .difficulty-line {
      margin-top: 2px;
    }

    .grid-wrapper {
      margin-top: 6px;
      padding: 10px;
      border-radius: 14px;
      background: #f3f4f6;  
      border: 1px solid #e5e7eb;
      box-shadow: inset 0 0 6px rgba(148, 163, 184, 0.3);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .cell {
      position: relative;
      aspect-ratio: 1 / 1;
      border-radius: 10px;
      background: #ffffff;
      border: 1px solid #d1d5db;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.06s ease, border-color 0.1s ease;
    }
    .cell:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.7);
      border-color: #1f2937;
    }

    .window-inner {
      position: absolute;
      inset: 3px;
      border-radius: 7px;
      background: radial-gradient(circle at top, #0b1120 0%, #020617 45%, #020617 100%);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      padding-bottom: 5px;
      overflow: hidden;
    }
    .window-glass {
      position: absolute;
      inset: 0;
      border-radius: 7px;
      box-shadow: inset 0 0 16px rgba(148, 163, 184, 0.4);
      opacity: 0.85;
    }
    .window-frame {
      position: absolute;
      inset: 0;
      border-radius: 7px;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }
    .window-bar {
      position: absolute;
      inset: 0;
    }
    .window-bar::before,
    .window-bar::after {
      content: "";
      position: absolute;
      background: rgba(15, 23, 42, 0.9);
    }
    .window-bar::before {
      width: 1px;
      height: 100%;
      left: 50%;
      transform: translateX(-0.5px);
    }
    .window-bar::after {
      height: 1px;
      width: 100%;
      top: 50%;
      transform: translateY(-0.5px);
    }

    /* 도둑/시민 이미지 */
    .thief {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      pointer-events: none;
    }
    .thief-img {
      width: 70%;
      max-width: 80px;
      transform: translateY(100%);
      opacity: 0;
      transition: transform 0.12s ease-out, opacity 0.12s ease-out;
      filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.9));
    }

    .cell.type-thief .thief-img {
      opacity: 1;
      transform: translateY(10%);
    }
    .cell.type-citizen .thief-img {
      opacity: 1;
      transform: translateY(5%);
    }

    /* 도둑: 빨간 불, 시민: 파란 불 */
    .cell.type-thief .window-glass {
      box-shadow: inset 0 0 24px rgba(239, 68, 68, 0.95);
    }
    .cell.type-citizen .window-glass {
      box-shadow: inset 0 0 24px rgba(59, 130, 246, 0.95);
    }

    .info-panel {
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
    }

    .controls {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }
    .status-text {
      color: #6b7280;
      line-height: 1.4;
      min-height: 30px;
    }
    .buttons {
      display: flex;
      gap: 6px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: #f9fafb;
      box-shadow: 0 6px 12px rgba(37, 99, 235, 0.35);
      transition: background 0.12s ease, transform 0.08s ease, box-shadow 0.12s ease, opacity 0.1s ease;
    }
    button:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.4);
    }
    button:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
    }
    .btn-secondary {
      background: #6b7280;
      box-shadow: 0 6px 12px rgba(75, 85, 99, 0.4);
    }
    .btn-secondary:hover {
      background: #4b5563;
      box-shadow: 0 10px 18px rgba(75, 85, 99, 0.5);
    }
    .btn-hidden {
      opacity: 0;
      pointer-events: none;
    }

    /* 게임 시작 버튼은 더 넓게 */
    #startBtn {
      padding: 8px 26px;
      min-width: 110px;
    }

    /* 엔딩 모달 */
    .overlay {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.65), rgba(15, 23, 42, 0.9));
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 20;
    }
    .overlay.visible {
      display: flex;
    }
    .modal {
      width: 100%;
      max-width: 320px;
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
      padding: 18px 16px 16px;
      text-align: center;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #111827;
    }
    .modal-rank {
      font-size: 22px;
      font-weight: 800;
      color: #b45309;
      margin-bottom: 8px;
    }
    .ending-image {
      width: 200px;
      max-width: 80%;
      height: auto;
      border-radius: 14px;
      object-fit: cover;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.5);
      margin: 4px auto 10px;
      background: #020617;
    }
    .modal-score {
      font-size: 13px;
      color: #111827;
      margin-bottom: 4px;
    }
    .modal-msg {
      font-size: 12px;
      color: #4b5563;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    .modal-footer {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    .modal-buttons {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .share-hint {
      margin-top: 6px;
      font-size: 10px;
      color: #9ca3af;
      min-height: 12px;
    }

    @media (max-width: 420px) {
      .title {
        font-size: 18px;
      }
      .grid {
        gap: 6px;
      }
      .modal-buttons {
        flex-direction: column;
      }
      .modal-buttons button {
        width: 100%;
      }
    }
.grid-container, .window {
    pointer-events: auto;
}
    .modal-msg {
  display: none;
}

    
  </style>
</head>
<body>
  <div class="building-wrapper">
    <div class="building-roof"></div>
    <div class="building-body">
      <div class="game-container">
        <div class="header">
          <div class="title-box">
            <div class="title">도둑을 잡아라</div>
            <div class="subtitle">대저택 창문 사이로 숨어드는 도둑을 찾아 클릭하세요.</div>
          </div>
          <div class="status-box">
            <div><span class="label">점수</span> <span class="value" id="scoreDisplay">0</span></div>
             <div><span class="label">최고</span> <span class="value" id="bestDisplay">0</span></div>
            <div><span class="label">라이프</span> <span class="value" id="lifeDisplay">♥♥♥</span></div>
            <div class="difficulty-line">
              <span class="label">난이도</span>
              <span class="value" id="levelDisplay">연습 구간</span>
            </div>
          </div>
        </div>

        <div class="grid-wrapper">
          <div class="grid" id="grid">
            <!-- 9개 창문 -->
            <!-- 기본 이미지는 도둑 이미지로, 실제 타입은 JS에서 설정 -->
            <div class="cell" data-index="0">
              <div class="window-inner">
                <div class="window-glass"></div>
                <div class="window-frame"></div>
                <div class="window-bar"></div>
                <div class="thief">
                  <img src="images/thief-normal.png" alt="character" class="thief-img" />
                </div>
              </div>
            </div>
            <div class="cell" data-index="1">
              <div class="window-inner">
                <div class="window-glass"></div>
                <div class="window-frame"></div>
                <div class="window-bar"></div>
                <div class="thief">
                  <img src="images/thief-normal.png" alt="character" class="thief-img" />
                </div>
              </div>
            </div>
            <div class="cell" data-index="2">
              <div class="window-inner">
                <div class="window-glass"></div>
                <div class="window-frame"></div>
                <div class="window-bar"></div>
                <div class="thief">
                  <img src="images/thief-normal.png" alt="character" class="thief-img" />
                </div>
              </div>
            </div>
            <div class="cell" data-index="3">
              <div class="window-inner">
                <div class="window-glass"></div>
                <div class="window-frame"></div>
                <div class="window-bar"></div>
                <div class="thief">
                  <img src="images/thief-normal.png" alt="character" class="thief-img" />
                </div>
              </div>
            </div>
            <div class="cell" data-index="4">
              <div class="window-inner">
                <div class="window-glass"></div>
                <div class="window-frame"></div>
                <div class="window-bar"></div>
                <div class="thief">
                  <img src="images/thief-normal.png" alt="character" class="thief-img" />
                </div>
              </div>
            </div>
            <div class="cell" data-index="5">
              <div class="window-inner">
                <div class="window-glass"></div>
                <div class="window-frame"></div>
                <div class="window-bar"></div>
                <div class="thief">
                  <img src="images/thief-normal.png" alt="character" class="thief-img" />
                </div>
              </div>
            </div>
            <div class="cell" data-index="6">
              <div class="window-inner">
                <div class="window-glass"></div>
                <div class="window-frame"></div>
                <div class="window-bar"></div>
                <div class="thief">
                  <img src="images/thief-normal.png" alt="character" class="thief-img" />
                </div>
              </div>
            </div>
            <div class="cell" data-index="7">
              <div class="window-inner">
                <div class="window-glass"></div>
                <div class="window-frame"></div>
                <div class="window-bar"></div>
                <div class="thief">
                  <img src="images/thief-normal.png" alt="character" class="thief-img" />
                </div>
              </div>
            </div>
            <div class="cell" data-index="8">
              <div class="window-inner">
                <div class="window-glass"></div>
                <div class="window-frame"></div>
                <div class="window-bar"></div>
                <div class="thief">
                  <img src="images/thief-normal.png" alt="character" class="thief-img" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="info-panel">
          도둑: 빨간 불 (클릭해서 잡기) · 시민: 파란 불 (클릭하면 안 됨)
        </div>

        <div class="controls">
          <div class="status-text" id="statusText">
            시작 버튼을 누르면 창문 사이로 도둑과 시민이 무작위로 나타납니다.
          </div>
          <div class="buttons">
            <button id="startBtn">게임 시작</button>
            <button id="retryBtn" class="btn-secondary btn-hidden">다시 하기</button>
          </div>
        </div>

        <!-- 엔딩 오버레이 -->
        <div class="overlay" id="overlay">
          <div class="modal">
            <div class="modal-title" id="modalTitle">도둑잡기에 실패했습니다</div>
            <div class="modal-rank" id="modalRank">Rank: F</div>
            <img id="endingImage" class="ending-image" src="images/thief-normal.png" alt="ending" />
            <div class="modal-score" id="modalScore">최종 점수: 0점 (최고 기록: 0점)</div>
            <div class="modal-msg" id="modalMsg">
              점수에 따라 다른 엔딩 메시지가 표시됩니다.
            </div>
            <div class="modal-footer">
              <div class="modal-buttons">
                <button id="modalRetryBtn">다시 하기</button>
                <button id="shareBtn" class="btn-secondary">결과 공유하기</button>
              </div>
            </div>
            <div class="share-hint" id="shareHint"></div>
          </div>
        </div>

        <!-- 오디오 (BGM + 효과음) -->
        <audio id="bgm" src="audio/bgm.mp3" loop></audio>
        <audio id="sfxHit" src="audio/hit.mp3"></audio>
        <audio id="sfxMiss" src="audio/miss.mp3"></audio>
      </div>
    </div>
  </div>

  <script>
    // ----- 상태 변수 -----
    let gameState = "ready"; // ready, playing, gameover
    let score = 0;
    let bestScore = 0;
    let lives = 3;
    const maxLives = 3;

    let activeIndex = null;
    let activeType = null; // "thief" | "citizen"
    let visibleTimeoutId = null;
    let spawnTimeoutId = null;

    // ----- DOM -----
    const scoreDisplay = document.getElementById("scoreDisplay");
    const bestDisplay = document.getElementById("bestDisplay");
    const lifeDisplay = document.getElementById("lifeDisplay");
    const levelDisplay = document.getElementById("levelDisplay");
    const statusText = document.getElementById("statusText");
    const startBtn = document.getElementById("startBtn");
    const retryBtn = document.getElementById("retryBtn");

    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalRank = document.getElementById("modalRank");
    const modalScore = document.getElementById("modalScore");
    const modalMsg = document.getElementById("modalMsg");
    const modalRetryBtn = document.getElementById("modalRetryBtn");
    const shareBtn = document.getElementById("shareBtn");
    const shareHint = document.getElementById("shareHint");
    const endingImage = document.getElementById("endingImage");

    const cells = Array.from(document.querySelectorAll(".cell"));

    // 오디오
    const bgm = document.getElementById("bgm");
    const sfxHit = document.getElementById("sfxHit");
    const sfxMiss = document.getElementById("sfxMiss");

    function playBgm() {
      if (!bgm) return;
      bgm.volume = 0.4;
      bgm.currentTime = 0;
      bgm.play().catch(() => {});
    }
    function stopBgm() {
      if (!bgm) return;
      bgm.pause();
      bgm.currentTime = 0;
    }
    function playHitSound() {
      if (!sfxHit) return;
      sfxHit.currentTime = 0;
      sfxHit.play().catch(() => {});
    }
    function playMissSound() {
      if (!sfxMiss) return;
      sfxMiss.currentTime = 0;
      sfxMiss.play().catch(() => {});
    }

    // ----- 로컬 최고 기록 -----
    function loadBestScore() {
      const saved = localStorage.getItem("thief_best_score");
      bestScore = saved ? Number(saved) : 0;
      bestDisplay.textContent = bestScore;
    }
    function saveBestScore() {
      if (score > bestScore) {
        bestScore = score;
        localStorage.setItem("thief_best_score", String(bestScore));
        bestDisplay.textContent = bestScore;
        return true;
      }
      return false;
    }

    loadBestScore();

    // ----- 라이프 표시 -----
    function renderLives() {
      const full = "♥".repeat(lives);
      const empty = "♡".repeat(maxLives - lives);
      lifeDisplay.textContent = full + empty;
    }

    // ----- 난이도 -----
    function getDifficulty(score) {
      if (score < 5) {
        return {
          label: "연습 구간",
          spawnInterval: 900,
          visibleTime: 800,
          thiefChance: 0.6
        };
      } else if (score < 15) {
        return {
          label: "초급",
          spawnInterval: 850,
          visibleTime: 700,
          thiefChance: 0.65
        };
      } else if (score < 25) {
        return {
          label: "중급",
          spawnInterval: 800,
          visibleTime: 600,
          thiefChance: 0.7
        };
      } else if (score < 35) {
        return {
          label: "상급",
          spawnInterval: 750,
          visibleTime: 520,
          thiefChance: 0.75
        };
      } else {
        return {
          label: "전설의 구간",
          spawnInterval: 700,
          visibleTime: 450,
          thiefChance: 0.8
        };
      }
    }

    function updateDifficultyLabel() {
      const diff = getDifficulty(score);
      levelDisplay.textContent = diff.label;
    }

    // ----- 셀 초기화 -----
    function resetCells() {
      cells.forEach(cell => {
        cell.classList.remove("type-thief", "type-citizen");
        const img = cell.querySelector(".thief-img");
        if (img) {
          img.src = "images/thief-normal.png";
        }
      });
      activeIndex = null;
      activeType = null;
    }

    function resetGameState() {
      clearTimeout(visibleTimeoutId);
      clearTimeout(spawnTimeoutId);
      visibleTimeoutId = null;
      spawnTimeoutId = null;
      score = 0;
      lives = maxLives;
      resetCells();
      renderLives();
      scoreDisplay.textContent = "0";
      updateDifficultyLabel();
      statusText.textContent =
        "도둑(빨간 불)은 클릭해서 잡고, 시민(파란 불)은 절대 누르지 마세요.";
    }

    // ----- 점수/라이프 처리 -----
    function addScore(delta) {
      score += delta;
      scoreDisplay.textContent = score;
    }

    function loseLifeAndScore() {
      if (lives <= 0) return;
      lives = Math.max(0, lives - 1);
      renderLives();
      addScore(-1);
      playMissSound();
    }

    // ----- 도둑/시민 등장 -----
    function scheduleNextSpawn(delay) {
      clearTimeout(spawnTimeoutId);
      spawnTimeoutId = setTimeout(() => {
        if (gameState !== "playing") return;
        spawnCharacter();
      }, delay);
    }

    function clearActiveAndScheduleNext() {
      resetCells();
      if (gameState === "playing") {
        const diff = getDifficulty(score);
        scheduleNextSpawn(diff.spawnInterval);
      }
    }

    function spawnCharacter() {
      if (gameState !== "playing") return;

      resetCells();

      const diff = getDifficulty(score);
      const isThief = Math.random() < diff.thiefChance;
      activeType = isThief ? "thief" : "citizen";

      let idx = Math.floor(Math.random() * cells.length);
      activeIndex = idx;

      const cell = cells[idx];
      const img = cell.querySelector(".thief-img");

      if (activeType === "thief") {
        cell.classList.add("type-thief");
        if (img) img.src = "images/thief-normal.png";
      } else {
        cell.classList.add("type-citizen");
        if (img) img.src = "images/citizen.png"; // 시민용 이미지(원하시면 교체)
      }

      const visibleTime = diff.visibleTime;

      clearTimeout(visibleTimeoutId);
      visibleTimeoutId = setTimeout(() => {
        if (activeIndex !== null) {
          // 도둑을 놓치면 -1점 & 라이프 감소, 시민은 아무 변화 없음
          if (activeType === "thief") {
            loseLifeAndScore();
            statusText.textContent =
              "도둑을 놓쳤습니다! 점수와 라이프가 1씩 감소했습니다.";
          } else {
            statusText.textContent =
              "시민이 무사히 지나갔습니다. 점수 변화는 없습니다.";
          }
          checkGameOverOrContinue();
        }
      }, visibleTime);
    }

    // ----- 게임 흐름 -----
    function startGame() {
      if (gameState === "playing") return;
      resetGameState();
      gameState = "playing";
      startBtn.classList.add("btn-hidden");
      retryBtn.classList.add("btn-hidden");
      playBgm();
      spawnCharacter();
    }

    function endGame() {
      gameState = "gameover";
      clearTimeout(visibleTimeoutId);
      clearTimeout(spawnTimeoutId);
      resetCells();
      stopBgm();
      startBtn.classList.remove("btn-hidden");
      retryBtn.classList.remove("btn-hidden");
      showEndingModal();
    }

    function checkGameOverOrContinue() {
      activeIndex = null;
      activeType = null;
      if (lives <= 0) {
        endGame();
      } else {
        clearActiveAndScheduleNext();
      }
    }

   // ----- 엔딩 분기 (S ~ F, 7단계) -----
function getEndingInfo(score) {
  // 점수 구간은 필요에 따라 자유롭게 조정하셔도 됩니다.
  let title, msg, rank, imgSrc;

  if (score < 5) {
    rank = "F";
    imgSrc = "images/ending-f.png";
    title = "도둑잡기에 실패했습니다";
    msg = "집이 완전히 도둑 소굴이 되었습니다. 다음에는 시민과 도둑을 더 확실하게 구분해 보세요.";
  } else if (score < 10) {
    rank = "E";
    imgSrc = "images/ending-e.png";
    title = "위태로운 밤";
    msg = "몇몇 도둑은 잡았지만, 여전히 집이 불안합니다. 반응 속도를 조금만 더 올려볼까요?";
  } else if (score < 18) {
    rank = "D";
    imgSrc = "images/ending-d.png";
    title = "아슬아슬하게 지켜낸 집";
    msg = "큰 피해는 막았지만, 도둑들이 다시 올 것 같습니다. 더 집중해 보세요.";
  } else if (score < 26) {
    rank = "C";
    imgSrc = "images/ending-c.png";
    title = "경비원으로 합격입니다";
    msg = "도둑과 시민을 꽤 잘 구분해냈습니다. 집을 지키는 데 큰 도움을 줬습니다.";
  } else if (score < 34) {
    rank = "B";
    imgSrc = "images/ending-b.png";
    title = "오늘의 히어로!";
    msg = "대부분의 도둑을 검거했습니다. 주민들이 박수치고 있습니다.";
  } else if (score < 45) {
    rank = "A";
    imgSrc = "images/ending-a.png";
    title = "전설적인 경비대장";
    msg = "도둑들은 더 이상 이 집을 노리지 않을 겁니다. 완벽에 가까운 수비였습니다.";
  } else {
    rank = "S";
    imgSrc = "images/ending-s.png";
    title = "신화급 도둑 사냥꾼";
    msg = "당신의 이름은 이 대저택의 전설로 남게 되었습니다.";
  }

  return { title, msg, rank, imgSrc };
}

    function showEndingModal() {
      const bestUpdated = saveBestScore();
      const ending = getEndingInfo(score);

      modalTitle.textContent = ending.title;
      modalRank.textContent = "Rank: " + ending.rank;
      modalScore.textContent =
        `최종 점수: ${score}점 (최고 기록: ${bestScore}점${bestUpdated ? " - 기록 갱신!" : ""})`;
      modalMsg.textContent = ending.msg;
      endingImage.src = ending.imgSrc;
      shareHint.textContent = "";

      overlay.classList.add("visible");
    }

    function hideEndingModal() {
      overlay.classList.remove("visible");
    }

    // ----- 공유하기 -----
    function getShareText() {
      const ending = getEndingInfo(score);
      const url = window.location.href;
      return `[도둑을 잡아라 결과]\n` +
             `점수: ${score}점\n` +
             `랭크: ${ending.rank}\n` +
             `${ending.title}\n\n` +
             `당신도 도전해 보세요: ${url}`;
    }

    async function shareResult() {
      const text = getShareText();

      if (navigator.share) {
        try {
          await navigator.share({
            title: "도둑을 잡아라",
            text,
            url: window.location.href
          });
          shareHint.textContent = "공유 창이 열렸습니다. 친구에게 결과를 자랑해 보세요.";
        } catch (err) {
          shareHint.textContent = "공유가 취소되었습니다.";
        }
      } else if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          shareHint.textContent =
            "결과가 클립보드에 복사되었습니다. 친구에게 붙여넣기해서 공유해 보세요.";
        } catch (err) {
          shareHint.textContent =
            "클립보드 복사에 실패했습니다. 브라우저 보안 설정을 확인해 주세요.";
        }
      } else {
        shareHint.textContent =
          "이 브라우저에서는 자동 복사가 어렵습니다. 결과를 직접 캡처해서 공유해 주세요.";
      }
    }

    // ----- 이벤트 -----
    startBtn.addEventListener("click", () => {
      if (gameState === "gameover") {
        hideEndingModal();
      }
      startGame();
    });

    retryBtn.addEventListener("click", () => {
      if (gameState === "gameover") {
        hideEndingModal();
      }
      startGame();
    });

    modalRetryBtn.addEventListener("click", () => {
      hideEndingModal();
      startGame();
    });

    shareBtn.addEventListener("click", () => {
      shareResult();
    });

    cells.forEach(cell => {
      cell.addEventListener("click", () => {
        if (gameState !== "playing") return;

        const idx = Number(cell.getAttribute("data-index"));

        if (activeIndex !== null && idx === activeIndex) {
          // 활성 창을 클릭한 경우
          if (activeType === "thief") {
            // 도둑 클릭: +1점
            addScore(1);
            playHitSound();
            statusText.textContent =
              "도둑을 잡았습니다! 점수 +1점.";
          } else if (activeType === "citizen") {
            // 시민 클릭: -1점 & 라이프 감소
            loseLifeAndScore();
            statusText.textContent =
              "시민을 잘못 클릭했습니다! 점수와 라이프가 1씩 감소했습니다.";
          }
          checkGameOverOrContinue();
        } else {
          // 활성 창이 아닌 곳을 클릭 → 실수로 처리
          loseLifeAndScore();
          statusText.textContent =
            "빈 창문을 클릭했습니다. 실수로 인한 경고! 점수와 라이프가 1씩 감소했습니다.";
          if (lives <= 0) {
            endGame();
          }
        }
      });
    });

    // 초기 상태
    renderLives();
    updateDifficultyLabel();
  </script>
</body>
</html>
